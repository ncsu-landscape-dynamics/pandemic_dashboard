{"ast":null,"code":"import { noTarget, isOfMetaType, isActiveFeature, isInactiveFeature, isShiftDown } from '../lib/common_selectors';\nimport createSupplementaryPoints from '../lib/create_supplementary_points';\nimport constrainFeatureMovement from '../lib/constrain_feature_movement';\nimport doubleClickZoom from '../lib/double_click_zoom';\nimport * as Constants from '../constants';\nimport moveFeatures from '../lib/move_features';\nconst isVertex = isOfMetaType(Constants.meta.VERTEX);\nconst isMidpoint = isOfMetaType(Constants.meta.MIDPOINT);\nconst DirectSelect = {}; // INTERNAL FUCNTIONS\n\nDirectSelect.fireUpdate = function () {\n  this.map.fire(Constants.events.UPDATE, {\n    action: Constants.updateActions.CHANGE_COORDINATES,\n    features: this.getSelected().map(f => f.toGeoJSON())\n  });\n};\n\nDirectSelect.fireActionable = function (state) {\n  this.setActionableState({\n    combineFeatures: false,\n    uncombineFeatures: false,\n    trash: state.selectedCoordPaths.length > 0\n  });\n};\n\nDirectSelect.startDragging = function (state, e) {\n  this.map.dragPan.disable();\n  state.canDragMove = true;\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.stopDragging = function (state) {\n  this.map.dragPan.enable();\n  state.dragMoving = false;\n  state.canDragMove = false;\n  state.dragMoveLocation = null;\n};\n\nDirectSelect.onVertex = function (state, e) {\n  this.startDragging(state, e);\n  const about = e.featureTarget.properties;\n  const selectedIndex = state.selectedCoordPaths.indexOf(about.coord_path);\n\n  if (!isShiftDown(e) && selectedIndex === -1) {\n    state.selectedCoordPaths = [about.coord_path];\n  } else if (isShiftDown(e) && selectedIndex === -1) {\n    state.selectedCoordPaths.push(about.coord_path);\n  }\n\n  const selectedCoordinates = this.pathsToCoordinates(state.featureId, state.selectedCoordPaths);\n  this.setSelectedCoordinates(selectedCoordinates);\n};\n\nDirectSelect.onMidpoint = function (state, e) {\n  this.startDragging(state, e);\n  const about = e.featureTarget.properties;\n  state.feature.addCoordinate(about.coord_path, about.lng, about.lat);\n  this.fireUpdate();\n  state.selectedCoordPaths = [about.coord_path];\n};\n\nDirectSelect.pathsToCoordinates = function (featureId, paths) {\n  return paths.map(coord_path => ({\n    feature_id: featureId,\n    coord_path\n  }));\n};\n\nDirectSelect.onFeature = function (state, e) {\n  if (state.selectedCoordPaths.length === 0) this.startDragging(state, e);else this.stopDragging(state);\n};\n\nDirectSelect.dragFeature = function (state, e, delta) {\n  moveFeatures(this.getSelected(), delta);\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.dragVertex = function (state, e, delta) {\n  const selectedCoords = state.selectedCoordPaths.map(coord_path => state.feature.getCoordinate(coord_path));\n  const selectedCoordPoints = selectedCoords.map(coords => ({\n    type: Constants.geojsonTypes.FEATURE,\n    properties: {},\n    geometry: {\n      type: Constants.geojsonTypes.POINT,\n      coordinates: coords\n    }\n  }));\n  const constrainedDelta = constrainFeatureMovement(selectedCoordPoints, delta);\n\n  for (let i = 0; i < selectedCoords.length; i++) {\n    const coord = selectedCoords[i];\n    state.feature.updateCoordinate(state.selectedCoordPaths[i], coord[0] + constrainedDelta.lng, coord[1] + constrainedDelta.lat);\n  }\n};\n\nDirectSelect.clickNoTarget = function () {\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\n};\n\nDirectSelect.clickInactive = function () {\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\n};\n\nDirectSelect.clickActiveFeature = function (state) {\n  state.selectedCoordPaths = [];\n  this.clearSelectedCoordinates();\n  state.feature.changed();\n}; // EXTERNAL FUNCTIONS\n\n\nDirectSelect.onSetup = function (opts) {\n  const featureId = opts.featureId;\n  const feature = this.getFeature(featureId);\n\n  if (!feature) {\n    throw new Error('You must provide a featureId to enter direct_select mode');\n  }\n\n  if (feature.type === Constants.geojsonTypes.POINT) {\n    throw new TypeError('direct_select mode doesn\\'t handle point features');\n  }\n\n  const state = {\n    featureId,\n    feature,\n    dragMoveLocation: opts.startPos || null,\n    dragMoving: false,\n    canDragMove: false,\n    selectedCoordPaths: opts.coordPath ? [opts.coordPath] : []\n  };\n  this.setSelectedCoordinates(this.pathsToCoordinates(featureId, state.selectedCoordPaths));\n  this.setSelected(featureId);\n  doubleClickZoom.disable(this);\n  this.setActionableState({\n    trash: true\n  });\n  return state;\n};\n\nDirectSelect.onStop = function () {\n  doubleClickZoom.enable(this);\n  this.clearSelectedCoordinates();\n};\n\nDirectSelect.toDisplayFeatures = function (state, geojson, push) {\n  if (state.featureId === geojson.properties.id) {\n    geojson.properties.active = Constants.activeStates.ACTIVE;\n    push(geojson);\n    createSupplementaryPoints(geojson, {\n      map: this.map,\n      midpoints: true,\n      selectedPaths: state.selectedCoordPaths\n    }).forEach(push);\n  } else {\n    geojson.properties.active = Constants.activeStates.INACTIVE;\n    push(geojson);\n  }\n\n  this.fireActionable(state);\n};\n\nDirectSelect.onTrash = function (state) {\n  // Uses number-aware sorting to make sure '9' < '10'. Comparison is reversed because we want them\n  // in reverse order so that we can remove by index safely.\n  state.selectedCoordPaths.sort((a, b) => b.localeCompare(a, 'en', {\n    numeric: true\n  })).forEach(id => state.feature.removeCoordinate(id));\n  this.fireUpdate();\n  state.selectedCoordPaths = [];\n  this.clearSelectedCoordinates();\n  this.fireActionable(state);\n\n  if (state.feature.isValid() === false) {\n    this.deleteFeature([state.featureId]);\n    this.changeMode(Constants.modes.SIMPLE_SELECT, {});\n  }\n};\n\nDirectSelect.onMouseMove = function (state, e) {\n  // On mousemove that is not a drag, stop vertex movement.\n  const isFeature = isActiveFeature(e);\n  const onVertex = isVertex(e);\n  const noCoords = state.selectedCoordPaths.length === 0;\n  if (isFeature && noCoords) this.updateUIClasses({\n    mouse: Constants.cursors.MOVE\n  });else if (onVertex && !noCoords) this.updateUIClasses({\n    mouse: Constants.cursors.MOVE\n  });else this.updateUIClasses({\n    mouse: Constants.cursors.NONE\n  });\n  this.stopDragging(state);\n};\n\nDirectSelect.onMouseOut = function (state) {\n  // As soon as you mouse leaves the canvas, update the feature\n  if (state.dragMoving) this.fireUpdate();\n};\n\nDirectSelect.onTouchStart = DirectSelect.onMouseDown = function (state, e) {\n  if (isVertex(e)) return this.onVertex(state, e);\n  if (isActiveFeature(e)) return this.onFeature(state, e);\n  if (isMidpoint(e)) return this.onMidpoint(state, e);\n};\n\nDirectSelect.onDrag = function (state, e) {\n  if (state.canDragMove !== true) return;\n  state.dragMoving = true;\n  e.originalEvent.stopPropagation();\n  const delta = {\n    lng: e.lngLat.lng - state.dragMoveLocation.lng,\n    lat: e.lngLat.lat - state.dragMoveLocation.lat\n  };\n  if (state.selectedCoordPaths.length > 0) this.dragVertex(state, e, delta);else this.dragFeature(state, e, delta);\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.onClick = function (state, e) {\n  if (noTarget(e)) return this.clickNoTarget(state, e);\n  if (isActiveFeature(e)) return this.clickActiveFeature(state, e);\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\n  this.stopDragging(state);\n};\n\nDirectSelect.onTap = function (state, e) {\n  if (noTarget(e)) return this.clickNoTarget(state, e);\n  if (isActiveFeature(e)) return this.clickActiveFeature(state, e);\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\n};\n\nDirectSelect.onTouchEnd = DirectSelect.onMouseUp = function (state) {\n  if (state.dragMoving) {\n    this.fireUpdate();\n  }\n\n  this.stopDragging(state);\n};\n\nexport default DirectSelect;","map":{"version":3,"sources":["/Users/garrettmillar/pandemic_dashboard/node_modules/@mapbox/mapbox-gl-draw/src/modes/direct_select.js"],"names":["noTarget","isOfMetaType","isActiveFeature","isInactiveFeature","isShiftDown","createSupplementaryPoints","constrainFeatureMovement","doubleClickZoom","Constants","moveFeatures","isVertex","meta","VERTEX","isMidpoint","MIDPOINT","DirectSelect","fireUpdate","map","fire","events","UPDATE","action","updateActions","CHANGE_COORDINATES","features","getSelected","f","toGeoJSON","fireActionable","state","setActionableState","combineFeatures","uncombineFeatures","trash","selectedCoordPaths","length","startDragging","e","dragPan","disable","canDragMove","dragMoveLocation","lngLat","stopDragging","enable","dragMoving","onVertex","about","featureTarget","properties","selectedIndex","indexOf","coord_path","push","selectedCoordinates","pathsToCoordinates","featureId","setSelectedCoordinates","onMidpoint","feature","addCoordinate","lng","lat","paths","feature_id","onFeature","dragFeature","delta","dragVertex","selectedCoords","getCoordinate","selectedCoordPoints","coords","type","geojsonTypes","FEATURE","geometry","POINT","coordinates","constrainedDelta","i","coord","updateCoordinate","clickNoTarget","changeMode","modes","SIMPLE_SELECT","clickInactive","clickActiveFeature","clearSelectedCoordinates","changed","onSetup","opts","getFeature","Error","TypeError","startPos","coordPath","setSelected","onStop","toDisplayFeatures","geojson","id","active","activeStates","ACTIVE","midpoints","selectedPaths","forEach","INACTIVE","onTrash","sort","a","b","localeCompare","numeric","removeCoordinate","isValid","deleteFeature","onMouseMove","isFeature","noCoords","updateUIClasses","mouse","cursors","MOVE","NONE","onMouseOut","onTouchStart","onMouseDown","onDrag","originalEvent","stopPropagation","onClick","onTap","onTouchEnd","onMouseUp"],"mappings":"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","sourcesContent":["import {noTarget, isOfMetaType, isActiveFeature, isInactiveFeature, isShiftDown} from '../lib/common_selectors';\nimport createSupplementaryPoints from '../lib/create_supplementary_points';\nimport constrainFeatureMovement from '../lib/constrain_feature_movement';\nimport doubleClickZoom from '../lib/double_click_zoom';\nimport * as Constants from '../constants';\nimport moveFeatures from '../lib/move_features';\n\nconst isVertex = isOfMetaType(Constants.meta.VERTEX);\nconst isMidpoint = isOfMetaType(Constants.meta.MIDPOINT);\n\nconst DirectSelect = {};\n\n// INTERNAL FUCNTIONS\n\nDirectSelect.fireUpdate = function() {\n  this.map.fire(Constants.events.UPDATE, {\n    action: Constants.updateActions.CHANGE_COORDINATES,\n    features: this.getSelected().map(f => f.toGeoJSON())\n  });\n};\n\nDirectSelect.fireActionable = function(state) {\n  this.setActionableState({\n    combineFeatures: false,\n    uncombineFeatures: false,\n    trash: state.selectedCoordPaths.length > 0\n  });\n};\n\nDirectSelect.startDragging = function(state, e) {\n  this.map.dragPan.disable();\n  state.canDragMove = true;\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.stopDragging = function(state) {\n  this.map.dragPan.enable();\n  state.dragMoving = false;\n  state.canDragMove = false;\n  state.dragMoveLocation = null;\n};\n\nDirectSelect.onVertex = function (state, e) {\n  this.startDragging(state, e);\n  const about = e.featureTarget.properties;\n  const selectedIndex = state.selectedCoordPaths.indexOf(about.coord_path);\n  if (!isShiftDown(e) && selectedIndex === -1) {\n    state.selectedCoordPaths = [about.coord_path];\n  } else if (isShiftDown(e) && selectedIndex === -1) {\n    state.selectedCoordPaths.push(about.coord_path);\n  }\n\n  const selectedCoordinates = this.pathsToCoordinates(state.featureId, state.selectedCoordPaths);\n  this.setSelectedCoordinates(selectedCoordinates);\n};\n\nDirectSelect.onMidpoint = function(state, e) {\n  this.startDragging(state, e);\n  const about = e.featureTarget.properties;\n  state.feature.addCoordinate(about.coord_path, about.lng, about.lat);\n  this.fireUpdate();\n  state.selectedCoordPaths = [about.coord_path];\n};\n\nDirectSelect.pathsToCoordinates = function(featureId, paths) {\n  return paths.map(coord_path => ({ feature_id: featureId, coord_path }));\n};\n\nDirectSelect.onFeature = function(state, e) {\n  if (state.selectedCoordPaths.length === 0) this.startDragging(state, e);\n  else this.stopDragging(state);\n};\n\nDirectSelect.dragFeature = function(state, e, delta) {\n  moveFeatures(this.getSelected(), delta);\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.dragVertex = function(state, e, delta) {\n  const selectedCoords = state.selectedCoordPaths.map(coord_path => state.feature.getCoordinate(coord_path));\n  const selectedCoordPoints = selectedCoords.map(coords => ({\n    type: Constants.geojsonTypes.FEATURE,\n    properties: {},\n    geometry: {\n      type: Constants.geojsonTypes.POINT,\n      coordinates: coords\n    }\n  }));\n\n  const constrainedDelta = constrainFeatureMovement(selectedCoordPoints, delta);\n  for (let i = 0; i < selectedCoords.length; i++) {\n    const coord = selectedCoords[i];\n    state.feature.updateCoordinate(state.selectedCoordPaths[i], coord[0] + constrainedDelta.lng, coord[1] + constrainedDelta.lat);\n  }\n};\n\nDirectSelect.clickNoTarget = function () {\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\n};\n\nDirectSelect.clickInactive = function () {\n  this.changeMode(Constants.modes.SIMPLE_SELECT);\n};\n\nDirectSelect.clickActiveFeature = function (state) {\n  state.selectedCoordPaths = [];\n  this.clearSelectedCoordinates();\n  state.feature.changed();\n};\n\n// EXTERNAL FUNCTIONS\n\nDirectSelect.onSetup = function(opts) {\n  const featureId = opts.featureId;\n  const feature = this.getFeature(featureId);\n\n  if (!feature) {\n    throw new Error('You must provide a featureId to enter direct_select mode');\n  }\n\n  if (feature.type === Constants.geojsonTypes.POINT) {\n    throw new TypeError('direct_select mode doesn\\'t handle point features');\n  }\n\n  const state = {\n    featureId,\n    feature,\n    dragMoveLocation: opts.startPos || null,\n    dragMoving: false,\n    canDragMove: false,\n    selectedCoordPaths: opts.coordPath ? [opts.coordPath] : []\n  };\n\n  this.setSelectedCoordinates(this.pathsToCoordinates(featureId, state.selectedCoordPaths));\n  this.setSelected(featureId);\n  doubleClickZoom.disable(this);\n\n  this.setActionableState({\n    trash: true\n  });\n\n  return state;\n};\n\nDirectSelect.onStop = function() {\n  doubleClickZoom.enable(this);\n  this.clearSelectedCoordinates();\n};\n\nDirectSelect.toDisplayFeatures = function(state, geojson, push) {\n  if (state.featureId === geojson.properties.id) {\n    geojson.properties.active = Constants.activeStates.ACTIVE;\n    push(geojson);\n    createSupplementaryPoints(geojson, {\n      map: this.map,\n      midpoints: true,\n      selectedPaths: state.selectedCoordPaths\n    }).forEach(push);\n  } else {\n    geojson.properties.active = Constants.activeStates.INACTIVE;\n    push(geojson);\n  }\n  this.fireActionable(state);\n};\n\nDirectSelect.onTrash = function(state) {\n  // Uses number-aware sorting to make sure '9' < '10'. Comparison is reversed because we want them\n  // in reverse order so that we can remove by index safely.\n  state.selectedCoordPaths\n    .sort((a, b) => b.localeCompare(a, 'en', { numeric: true }))\n    .forEach(id => state.feature.removeCoordinate(id));\n  this.fireUpdate();\n  state.selectedCoordPaths = [];\n  this.clearSelectedCoordinates();\n  this.fireActionable(state);\n  if (state.feature.isValid() === false) {\n    this.deleteFeature([state.featureId]);\n    this.changeMode(Constants.modes.SIMPLE_SELECT, {});\n  }\n};\n\nDirectSelect.onMouseMove = function(state, e) {\n  // On mousemove that is not a drag, stop vertex movement.\n  const isFeature = isActiveFeature(e);\n  const onVertex = isVertex(e);\n  const noCoords = state.selectedCoordPaths.length === 0;\n  if (isFeature && noCoords) this.updateUIClasses({ mouse: Constants.cursors.MOVE });\n  else if (onVertex && !noCoords) this.updateUIClasses({ mouse: Constants.cursors.MOVE });\n  else this.updateUIClasses({ mouse: Constants.cursors.NONE });\n  this.stopDragging(state);\n};\n\nDirectSelect.onMouseOut = function(state) {\n  // As soon as you mouse leaves the canvas, update the feature\n  if (state.dragMoving) this.fireUpdate();\n};\n\nDirectSelect.onTouchStart = DirectSelect.onMouseDown = function(state, e) {\n  if (isVertex(e)) return this.onVertex(state, e);\n  if (isActiveFeature(e)) return this.onFeature(state, e);\n  if (isMidpoint(e)) return this.onMidpoint(state, e);\n};\n\nDirectSelect.onDrag = function(state, e) {\n  if (state.canDragMove !== true) return;\n  state.dragMoving = true;\n  e.originalEvent.stopPropagation();\n\n  const delta = {\n    lng: e.lngLat.lng - state.dragMoveLocation.lng,\n    lat: e.lngLat.lat - state.dragMoveLocation.lat\n  };\n  if (state.selectedCoordPaths.length > 0) this.dragVertex(state, e, delta);\n  else this.dragFeature(state, e, delta);\n\n  state.dragMoveLocation = e.lngLat;\n};\n\nDirectSelect.onClick = function(state, e) {\n  if (noTarget(e)) return this.clickNoTarget(state, e);\n  if (isActiveFeature(e)) return this.clickActiveFeature(state, e);\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\n  this.stopDragging(state);\n};\n\nDirectSelect.onTap = function(state, e) {\n  if (noTarget(e)) return this.clickNoTarget(state, e);\n  if (isActiveFeature(e)) return this.clickActiveFeature(state, e);\n  if (isInactiveFeature(e)) return this.clickInactive(state, e);\n};\n\nDirectSelect.onTouchEnd = DirectSelect.onMouseUp = function(state) {\n  if (state.dragMoving) {\n    this.fireUpdate();\n  }\n  this.stopDragging(state);\n};\n\nexport default DirectSelect;\n\n"]},"metadata":{},"sourceType":"module"}