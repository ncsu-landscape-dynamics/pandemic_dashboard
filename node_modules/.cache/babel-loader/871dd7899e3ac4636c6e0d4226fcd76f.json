{"ast":null,"code":"var BIG_ENDIAN = false;\nvar LITTLE_ENDIAN = true;\nexport function getBinaryImageMetadata(binaryData) {\n  var dataView = toDataView(binaryData);\n  return getPngMetadata(dataView) || getJpegMetadata(dataView) || getGifMetadata(dataView) || getBmpMetadata(dataView);\n}\n\nfunction getPngMetadata(binaryData) {\n  var dataView = toDataView(binaryData);\n  var isPng = dataView.byteLength >= 24 && dataView.getUint32(0, BIG_ENDIAN) === 0x89504e47;\n\n  if (!isPng) {\n    return null;\n  }\n\n  return {\n    mimeType: 'image/png',\n    width: dataView.getUint32(16, BIG_ENDIAN),\n    height: dataView.getUint32(20, BIG_ENDIAN)\n  };\n}\n\nfunction getGifMetadata(binaryData) {\n  var dataView = toDataView(binaryData);\n  var isGif = dataView.byteLength >= 10 && dataView.getUint32(0, BIG_ENDIAN) === 0x47494638;\n\n  if (!isGif) {\n    return null;\n  }\n\n  return {\n    mimeType: 'image/gif',\n    width: dataView.getUint16(6, LITTLE_ENDIAN),\n    height: dataView.getUint16(8, LITTLE_ENDIAN)\n  };\n}\n\nexport function getBmpMetadata(binaryData) {\n  var dataView = toDataView(binaryData);\n  var isBmp = dataView.byteLength >= 14 && dataView.getUint16(0, BIG_ENDIAN) === 0x424d && dataView.getUint32(2, LITTLE_ENDIAN) === dataView.byteLength;\n\n  if (!isBmp) {\n    return null;\n  }\n\n  return {\n    mimeType: 'image/bmp',\n    width: dataView.getUint32(18, LITTLE_ENDIAN),\n    height: dataView.getUint32(22, LITTLE_ENDIAN)\n  };\n}\n\nfunction getJpegMetadata(binaryData) {\n  var dataView = toDataView(binaryData);\n  var isJpeg = dataView.byteLength >= 3 && dataView.getUint16(0, BIG_ENDIAN) === 0xffd8 && dataView.getUint8(2) === 0xff;\n\n  if (!isJpeg) {\n    return null;\n  }\n\n  var _getJpegMarkers = getJpegMarkers(),\n      tableMarkers = _getJpegMarkers.tableMarkers,\n      sofMarkers = _getJpegMarkers.sofMarkers;\n\n  var i = 2;\n\n  while (i + 9 < dataView.byteLength) {\n    var marker = dataView.getUint16(i, BIG_ENDIAN);\n\n    if (sofMarkers.has(marker)) {\n      return {\n        mimeType: 'image/jpeg',\n        height: dataView.getUint16(i + 5, BIG_ENDIAN),\n        width: dataView.getUint16(i + 7, BIG_ENDIAN)\n      };\n    }\n\n    if (!tableMarkers.has(marker)) {\n      return null;\n    }\n\n    i += 2;\n    i += dataView.getUint16(i, BIG_ENDIAN);\n  }\n\n  return null;\n}\n\nfunction getJpegMarkers() {\n  var tableMarkers = new Set([0xffdb, 0xffc4, 0xffcc, 0xffdd, 0xfffe]);\n\n  for (var i = 0xffe0; i < 0xfff0; ++i) {\n    tableMarkers.add(i);\n  }\n\n  var sofMarkers = new Set([0xffc0, 0xffc1, 0xffc2, 0xffc3, 0xffc5, 0xffc6, 0xffc7, 0xffc9, 0xffca, 0xffcb, 0xffcd, 0xffce, 0xffcf, 0xffde]);\n  return {\n    tableMarkers: tableMarkers,\n    sofMarkers: sofMarkers\n  };\n}\n\nfunction toDataView(data) {\n  if (data instanceof DataView) {\n    return data;\n  }\n\n  if (ArrayBuffer.isView(data)) {\n    return new DataView(data.buffer);\n  }\n\n  if (data instanceof ArrayBuffer) {\n    return new DataView(data);\n  }\n\n  throw new Error('toDataView');\n}","map":{"version":3,"sources":["../../../../src/lib/category-api/binary-image-api.js"],"names":["BIG_ENDIAN","LITTLE_ENDIAN","dataView","toDataView","getPngMetadata","getJpegMetadata","getGifMetadata","getBmpMetadata","isPng","mimeType","width","height","isGif","isBmp","isJpeg","tableMarkers","sofMarkers","getJpegMarkers","i","marker","data","ArrayBuffer"],"mappings":"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","sourcesContent":["// Attributions\n// * Based on binary-gltf-utils under MIT license: Copyright (c) 2016-17 Karl Cheng\n\n// TODO: make these functions work for Node.js buffers?\n// Quarantine references to Buffer to prevent bundler from adding big polyfills\n// import {bufferToArrayBuffer} from '../node/buffer-to-array-buffer';\n// TODO - this should be handled in @loaders.gl/polyfills\n\nconst BIG_ENDIAN = false;\nconst LITTLE_ENDIAN = true;\n\nexport function getBinaryImageMetadata(binaryData) {\n  const dataView = toDataView(binaryData);\n  return (\n    getPngMetadata(dataView) ||\n    getJpegMetadata(dataView) ||\n    getGifMetadata(dataView) ||\n    getBmpMetadata(dataView)\n  );\n}\n\n// PNG\n\nfunction getPngMetadata(binaryData) {\n  const dataView = toDataView(binaryData);\n  // Check file contains the first 4 bytes of the PNG signature.\n  const isPng = dataView.byteLength >= 24 && dataView.getUint32(0, BIG_ENDIAN) === 0x89504e47;\n  if (!isPng) {\n    return null;\n  }\n\n  // Extract size from a binary PNG file\n  return {\n    mimeType: 'image/png',\n    width: dataView.getUint32(16, BIG_ENDIAN),\n    height: dataView.getUint32(20, BIG_ENDIAN)\n  };\n}\n\n// GIF\n\n// Extract size from a binary GIF file\n// TODO: GIF is not this simple\nfunction getGifMetadata(binaryData) {\n  const dataView = toDataView(binaryData);\n  // Check first 4 bytes of the GIF signature (\"GIF8\").\n  const isGif = dataView.byteLength >= 10 && dataView.getUint32(0, BIG_ENDIAN) === 0x47494638;\n  if (!isGif) {\n    return null;\n  }\n\n  // GIF is little endian.\n  return {\n    mimeType: 'image/gif',\n    width: dataView.getUint16(6, LITTLE_ENDIAN),\n    height: dataView.getUint16(8, LITTLE_ENDIAN)\n  };\n}\n\n// BMP\n\n// TODO: BMP is not this simple\nexport function getBmpMetadata(binaryData) {\n  const dataView = toDataView(binaryData);\n  // Check magic number is valid (first 2 characters should be \"BM\").\n  // The mandatory bitmap file header is 14 bytes long.\n  const isBmp =\n    dataView.byteLength >= 14 &&\n    dataView.getUint16(0, BIG_ENDIAN) === 0x424d &&\n    dataView.getUint32(2, LITTLE_ENDIAN) === dataView.byteLength;\n\n  if (!isBmp) {\n    return null;\n  }\n\n  // BMP is little endian.\n  return {\n    mimeType: 'image/bmp',\n    width: dataView.getUint32(18, LITTLE_ENDIAN),\n    height: dataView.getUint32(22, LITTLE_ENDIAN)\n  };\n}\n\n// JPEG\n\n// Extract width and height from a binary JPEG file\nfunction getJpegMetadata(binaryData) {\n  const dataView = toDataView(binaryData);\n  // Check file contains the JPEG \"start of image\" (SOI) marker\n  // followed by another marker.\n  const isJpeg =\n    dataView.byteLength >= 3 &&\n    dataView.getUint16(0, BIG_ENDIAN) === 0xffd8 &&\n    dataView.getUint8(2) === 0xff;\n\n  if (!isJpeg) {\n    return null;\n  }\n\n  const {tableMarkers, sofMarkers} = getJpegMarkers();\n\n  // Exclude the two byte SOI marker.\n  let i = 2;\n  while (i + 9 < dataView.byteLength) {\n    const marker = dataView.getUint16(i, BIG_ENDIAN);\n\n    // The frame that contains the width and height of the JPEG image.\n    if (sofMarkers.has(marker)) {\n      return {\n        mimeType: 'image/jpeg',\n        height: dataView.getUint16(i + 5, BIG_ENDIAN), // Number of lines\n        width: dataView.getUint16(i + 7, BIG_ENDIAN) // Number of pixels per line\n      };\n    }\n\n    // Miscellaneous tables/data preceding the frame header.\n    if (!tableMarkers.has(marker)) {\n      return null;\n    }\n\n    // Length includes size of length parameter but not the two byte header.\n    i += 2;\n    i += dataView.getUint16(i, BIG_ENDIAN);\n  }\n\n  return null;\n}\n\nfunction getJpegMarkers() {\n  // Tables/misc header markers.\n  // DQT, DHT, DAC, DRI, COM, APP_n\n  const tableMarkers = new Set([0xffdb, 0xffc4, 0xffcc, 0xffdd, 0xfffe]);\n  for (let i = 0xffe0; i < 0xfff0; ++i) {\n    tableMarkers.add(i);\n  }\n\n  // SOF markers and DHP marker.\n  // These markers are after tables/misc data.\n  const sofMarkers = new Set([\n    0xffc0,\n    0xffc1,\n    0xffc2,\n    0xffc3,\n    0xffc5,\n    0xffc6,\n    0xffc7,\n    0xffc9,\n    0xffca,\n    0xffcb,\n    0xffcd,\n    0xffce,\n    0xffcf,\n    0xffde\n  ]);\n\n  return {tableMarkers, sofMarkers};\n}\n\n// TODO - move into image module?\nfunction toDataView(data) {\n  if (data instanceof DataView) {\n    return data;\n  }\n  if (ArrayBuffer.isView(data)) {\n    return new DataView(data.buffer);\n  }\n\n  // TODO: make these functions work for Node.js buffers?\n  // if (bufferToArrayBuffer) {\n  //   data = bufferToArrayBuffer(data);\n  // }\n\n  // Careful - Node Buffers will look like ArrayBuffers (keep after isBuffer)\n  if (data instanceof ArrayBuffer) {\n    return new DataView(data);\n  }\n  throw new Error('toDataView');\n}\n"]},"metadata":{},"sourceType":"module"}