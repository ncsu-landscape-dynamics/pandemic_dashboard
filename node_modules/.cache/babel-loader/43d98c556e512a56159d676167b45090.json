{"ast":null,"code":"import setupModeHandler from './lib/mode_handler';\nimport getFeaturesAndSetCursor from './lib/get_features_and_set_cursor';\nimport featuresAt from './lib/features_at';\nimport isClick from './lib/is_click';\nimport isTap from './lib/is_tap';\nimport * as Constants from './constants';\nimport objectToMode from './modes/object_to_mode';\nexport default function (ctx) {\n  const modes = Object.keys(ctx.options.modes).reduce((m, k) => {\n    m[k] = objectToMode(ctx.options.modes[k]);\n    return m;\n  }, {});\n  let mouseDownInfo = {};\n  let touchStartInfo = {};\n  const events = {};\n  let currentModeName = null;\n  let currentMode = null;\n\n  events.drag = function (event, isDrag) {\n    if (isDrag({\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      ctx.ui.queueMapClasses({\n        mouse: Constants.cursors.DRAG\n      });\n      currentMode.drag(event);\n    } else {\n      event.originalEvent.stopPropagation();\n    }\n  };\n\n  events.mousedrag = function (event) {\n    events.drag(event, endInfo => !isClick(mouseDownInfo, endInfo));\n  };\n\n  events.touchdrag = function (event) {\n    events.drag(event, endInfo => !isTap(touchStartInfo, endInfo));\n  };\n\n  events.mousemove = function (event) {\n    const button = event.originalEvent.buttons !== undefined ? event.originalEvent.buttons : event.originalEvent.which;\n\n    if (button === 1) {\n      return events.mousedrag(event);\n    }\n\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousemove(event);\n  };\n\n  events.mousedown = function (event) {\n    mouseDownInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousedown(event);\n  };\n\n  events.mouseup = function (event) {\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      currentMode.click(event);\n    } else {\n      currentMode.mouseup(event);\n    }\n  };\n\n  events.mouseout = function (event) {\n    currentMode.mouseout(event);\n  };\n\n  events.touchstart = function (event) {\n    // Prevent emulated mouse events because we will fully handle the touch here.\n    // This does not stop the touch events from propogating to mapbox though.\n    event.originalEvent.preventDefault();\n\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    touchStartInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    const target = featuresAt.touch(event, null, ctx)[0];\n    event.featureTarget = target;\n    currentMode.touchstart(event);\n  };\n\n  events.touchmove = function (event) {\n    event.originalEvent.preventDefault();\n\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    currentMode.touchmove(event);\n    return events.touchdrag(event);\n  };\n\n  events.touchend = function (event) {\n    event.originalEvent.preventDefault();\n\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    const target = featuresAt.touch(event, null, ctx)[0];\n    event.featureTarget = target;\n\n    if (isTap(touchStartInfo, {\n      time: new Date().getTime(),\n      point: event.point\n    })) {\n      currentMode.tap(event);\n    } else {\n      currentMode.touchend(event);\n    }\n  }; // 8 - Backspace\n  // 46 - Delete\n\n\n  const isKeyModeValid = code => !(code === 8 || code === 46 || code >= 48 && code <= 57);\n\n  events.keydown = function (event) {\n    if ((event.srcElement || event.target).classList[0] !== 'mapboxgl-canvas') return; // we only handle events on the map\n\n    if ((event.keyCode === 8 || event.keyCode === 46) && ctx.options.controls.trash) {\n      event.preventDefault();\n      currentMode.trash();\n    } else if (isKeyModeValid(event.keyCode)) {\n      currentMode.keydown(event);\n    } else if (event.keyCode === 49 && ctx.options.controls.point) {\n      changeMode(Constants.modes.DRAW_POINT);\n    } else if (event.keyCode === 50 && ctx.options.controls.line_string) {\n      changeMode(Constants.modes.DRAW_LINE_STRING);\n    } else if (event.keyCode === 51 && ctx.options.controls.polygon) {\n      changeMode(Constants.modes.DRAW_POLYGON);\n    }\n  };\n\n  events.keyup = function (event) {\n    if (isKeyModeValid(event.keyCode)) {\n      currentMode.keyup(event);\n    }\n  };\n\n  events.zoomend = function () {\n    ctx.store.changeZoom();\n  };\n\n  events.data = function (event) {\n    if (event.dataType === 'style') {\n      const {\n        setup,\n        map,\n        options,\n        store\n      } = ctx;\n      const hasLayers = options.styles.some(style => map.getLayer(style.id));\n\n      if (!hasLayers) {\n        setup.addLayers();\n        store.setDirty();\n        store.render();\n      }\n    }\n  };\n\n  function changeMode(modename, nextModeOptions, eventOptions = {}) {\n    currentMode.stop();\n    const modebuilder = modes[modename];\n\n    if (modebuilder === undefined) {\n      throw new Error(`${modename} is not valid`);\n    }\n\n    currentModeName = modename;\n    const mode = modebuilder(ctx, nextModeOptions);\n    currentMode = setupModeHandler(mode, ctx);\n\n    if (!eventOptions.silent) {\n      ctx.map.fire(Constants.events.MODE_CHANGE, {\n        mode: modename\n      });\n    }\n\n    ctx.store.setDirty();\n    ctx.store.render();\n  }\n\n  const actionState = {\n    trash: false,\n    combineFeatures: false,\n    uncombineFeatures: false\n  };\n\n  function actionable(actions) {\n    let changed = false;\n    Object.keys(actions).forEach(action => {\n      if (actionState[action] === undefined) throw new Error('Invalid action type');\n      if (actionState[action] !== actions[action]) changed = true;\n      actionState[action] = actions[action];\n    });\n    if (changed) ctx.map.fire(Constants.events.ACTIONABLE, {\n      actions: actionState\n    });\n  }\n\n  const api = {\n    start() {\n      currentModeName = ctx.options.defaultMode;\n      currentMode = setupModeHandler(modes[currentModeName](ctx), ctx);\n    },\n\n    changeMode,\n    actionable,\n\n    currentModeName() {\n      return currentModeName;\n    },\n\n    currentModeRender(geojson, push) {\n      return currentMode.render(geojson, push);\n    },\n\n    fire(name, event) {\n      if (events[name]) {\n        events[name](event);\n      }\n    },\n\n    addEventListeners() {\n      ctx.map.on('mousemove', events.mousemove);\n      ctx.map.on('mousedown', events.mousedown);\n      ctx.map.on('mouseup', events.mouseup);\n      ctx.map.on('data', events.data);\n      ctx.map.on('touchmove', events.touchmove);\n      ctx.map.on('touchstart', events.touchstart);\n      ctx.map.on('touchend', events.touchend);\n      ctx.container.addEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.addEventListener('keydown', events.keydown);\n        ctx.container.addEventListener('keyup', events.keyup);\n      }\n    },\n\n    removeEventListeners() {\n      ctx.map.off('mousemove', events.mousemove);\n      ctx.map.off('mousedown', events.mousedown);\n      ctx.map.off('mouseup', events.mouseup);\n      ctx.map.off('data', events.data);\n      ctx.map.off('touchmove', events.touchmove);\n      ctx.map.off('touchstart', events.touchstart);\n      ctx.map.off('touchend', events.touchend);\n      ctx.container.removeEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.removeEventListener('keydown', events.keydown);\n        ctx.container.removeEventListener('keyup', events.keyup);\n      }\n    },\n\n    trash(options) {\n      currentMode.trash(options);\n    },\n\n    combineFeatures() {\n      currentMode.combineFeatures();\n    },\n\n    uncombineFeatures() {\n      currentMode.uncombineFeatures();\n    },\n\n    getMode() {\n      return currentModeName;\n    }\n\n  };\n  return api;\n}","map":{"version":3,"sources":["/Users/garrettmillar/pandemic_dashboard/node_modules/@mapbox/mapbox-gl-draw/src/events.js"],"names":["setupModeHandler","getFeaturesAndSetCursor","featuresAt","isClick","isTap","Constants","objectToMode","ctx","modes","Object","keys","options","reduce","m","k","mouseDownInfo","touchStartInfo","events","currentModeName","currentMode","drag","event","isDrag","point","time","Date","getTime","ui","queueMapClasses","mouse","cursors","DRAG","originalEvent","stopPropagation","mousedrag","endInfo","touchdrag","mousemove","button","buttons","undefined","which","target","featureTarget","mousedown","mouseup","click","mouseout","touchstart","preventDefault","touchEnabled","touch","touchmove","touchend","tap","isKeyModeValid","code","keydown","srcElement","classList","keyCode","controls","trash","changeMode","DRAW_POINT","line_string","DRAW_LINE_STRING","polygon","DRAW_POLYGON","keyup","zoomend","store","changeZoom","data","dataType","setup","map","hasLayers","styles","some","style","getLayer","id","addLayers","setDirty","render","modename","nextModeOptions","eventOptions","stop","modebuilder","Error","mode","silent","fire","MODE_CHANGE","actionState","combineFeatures","uncombineFeatures","actionable","actions","changed","forEach","action","ACTIONABLE","api","start","defaultMode","currentModeRender","geojson","push","name","addEventListeners","on","container","addEventListener","keybindings","removeEventListeners","off","removeEventListener","getMode"],"mappings":"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","sourcesContent":["import setupModeHandler from './lib/mode_handler';\nimport getFeaturesAndSetCursor from './lib/get_features_and_set_cursor';\nimport featuresAt from './lib/features_at';\nimport isClick from './lib/is_click';\nimport isTap from './lib/is_tap';\nimport * as Constants from './constants';\nimport objectToMode from './modes/object_to_mode';\n\nexport default function(ctx) {\n\n  const modes = Object.keys(ctx.options.modes).reduce((m, k) => {\n    m[k] = objectToMode(ctx.options.modes[k]);\n    return m;\n  }, {});\n\n  let mouseDownInfo = {};\n  let touchStartInfo = {};\n  const events = {};\n  let currentModeName = null;\n  let currentMode = null;\n\n  events.drag = function(event, isDrag) {\n    if (isDrag({\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      ctx.ui.queueMapClasses({ mouse: Constants.cursors.DRAG });\n      currentMode.drag(event);\n    } else {\n      event.originalEvent.stopPropagation();\n    }\n  };\n\n  events.mousedrag = function(event) {\n    events.drag(event, endInfo => !isClick(mouseDownInfo, endInfo));\n  };\n\n  events.touchdrag = function(event) {\n    events.drag(event, endInfo => !isTap(touchStartInfo, endInfo));\n  };\n\n  events.mousemove = function(event) {\n    const button = event.originalEvent.buttons !== undefined ? event.originalEvent.buttons : event.originalEvent.which;\n    if (button === 1) {\n      return events.mousedrag(event);\n    }\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousemove(event);\n  };\n\n  events.mousedown = function(event) {\n    mouseDownInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n    currentMode.mousedown(event);\n  };\n\n  events.mouseup = function(event) {\n    const target = getFeaturesAndSetCursor(event, ctx);\n    event.featureTarget = target;\n\n    if (isClick(mouseDownInfo, {\n      point: event.point,\n      time: new Date().getTime()\n    })) {\n      currentMode.click(event);\n    } else {\n      currentMode.mouseup(event);\n    }\n  };\n\n  events.mouseout = function(event) {\n    currentMode.mouseout(event);\n  };\n\n  events.touchstart = function(event) {\n    // Prevent emulated mouse events because we will fully handle the touch here.\n    // This does not stop the touch events from propogating to mapbox though.\n    event.originalEvent.preventDefault();\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    touchStartInfo = {\n      time: new Date().getTime(),\n      point: event.point\n    };\n    const target = featuresAt.touch(event, null, ctx)[0];\n    event.featureTarget = target;\n    currentMode.touchstart(event);\n  };\n\n  events.touchmove = function(event) {\n    event.originalEvent.preventDefault();\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    currentMode.touchmove(event);\n    return events.touchdrag(event);\n  };\n\n  events.touchend = function(event) {\n    event.originalEvent.preventDefault();\n    if (!ctx.options.touchEnabled) {\n      return;\n    }\n\n    const target = featuresAt.touch(event, null, ctx)[0];\n    event.featureTarget = target;\n    if (isTap(touchStartInfo, {\n      time: new Date().getTime(),\n      point: event.point\n    })) {\n      currentMode.tap(event);\n    } else {\n      currentMode.touchend(event);\n    }\n  };\n\n  // 8 - Backspace\n  // 46 - Delete\n  const isKeyModeValid = code => !(code === 8 || code === 46 || (code >= 48 && code <= 57));\n\n  events.keydown = function(event) {\n    if ((event.srcElement || event.target).classList[0] !== 'mapboxgl-canvas') return; // we only handle events on the map\n\n    if ((event.keyCode === 8 || event.keyCode === 46) && ctx.options.controls.trash) {\n      event.preventDefault();\n      currentMode.trash();\n    } else if (isKeyModeValid(event.keyCode)) {\n      currentMode.keydown(event);\n    } else if (event.keyCode === 49 && ctx.options.controls.point) {\n      changeMode(Constants.modes.DRAW_POINT);\n    } else if (event.keyCode === 50 && ctx.options.controls.line_string) {\n      changeMode(Constants.modes.DRAW_LINE_STRING);\n    } else if (event.keyCode === 51 && ctx.options.controls.polygon) {\n      changeMode(Constants.modes.DRAW_POLYGON);\n    }\n  };\n\n  events.keyup = function(event) {\n    if (isKeyModeValid(event.keyCode)) {\n      currentMode.keyup(event);\n    }\n  };\n\n  events.zoomend = function() {\n    ctx.store.changeZoom();\n  };\n\n  events.data = function(event) {\n    if (event.dataType === 'style') {\n      const { setup, map, options, store } = ctx;\n      const hasLayers = options.styles.some(style => map.getLayer(style.id));\n      if (!hasLayers) {\n        setup.addLayers();\n        store.setDirty();\n        store.render();\n      }\n    }\n  };\n\n  function changeMode(modename, nextModeOptions, eventOptions = {}) {\n    currentMode.stop();\n\n    const modebuilder = modes[modename];\n    if (modebuilder === undefined) {\n      throw new Error(`${modename} is not valid`);\n    }\n    currentModeName = modename;\n    const mode = modebuilder(ctx, nextModeOptions);\n    currentMode = setupModeHandler(mode, ctx);\n\n    if (!eventOptions.silent) {\n      ctx.map.fire(Constants.events.MODE_CHANGE, { mode: modename});\n    }\n\n    ctx.store.setDirty();\n    ctx.store.render();\n  }\n\n  const actionState = {\n    trash: false,\n    combineFeatures: false,\n    uncombineFeatures: false\n  };\n\n  function actionable(actions) {\n    let changed = false;\n    Object.keys(actions).forEach((action) => {\n      if (actionState[action] === undefined) throw new Error('Invalid action type');\n      if (actionState[action] !== actions[action]) changed = true;\n      actionState[action] = actions[action];\n    });\n    if (changed) ctx.map.fire(Constants.events.ACTIONABLE, { actions: actionState });\n  }\n\n  const api = {\n    start() {\n      currentModeName = ctx.options.defaultMode;\n      currentMode = setupModeHandler(modes[currentModeName](ctx), ctx);\n    },\n    changeMode,\n    actionable,\n    currentModeName() {\n      return currentModeName;\n    },\n    currentModeRender(geojson, push) {\n      return currentMode.render(geojson, push);\n    },\n    fire(name, event) {\n      if (events[name]) {\n        events[name](event);\n      }\n    },\n    addEventListeners() {\n      ctx.map.on('mousemove', events.mousemove);\n      ctx.map.on('mousedown', events.mousedown);\n      ctx.map.on('mouseup', events.mouseup);\n      ctx.map.on('data', events.data);\n\n      ctx.map.on('touchmove', events.touchmove);\n      ctx.map.on('touchstart', events.touchstart);\n      ctx.map.on('touchend', events.touchend);\n\n      ctx.container.addEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.addEventListener('keydown', events.keydown);\n        ctx.container.addEventListener('keyup', events.keyup);\n      }\n    },\n    removeEventListeners() {\n      ctx.map.off('mousemove', events.mousemove);\n      ctx.map.off('mousedown', events.mousedown);\n      ctx.map.off('mouseup', events.mouseup);\n      ctx.map.off('data', events.data);\n\n      ctx.map.off('touchmove', events.touchmove);\n      ctx.map.off('touchstart', events.touchstart);\n      ctx.map.off('touchend', events.touchend);\n\n      ctx.container.removeEventListener('mouseout', events.mouseout);\n\n      if (ctx.options.keybindings) {\n        ctx.container.removeEventListener('keydown', events.keydown);\n        ctx.container.removeEventListener('keyup', events.keyup);\n      }\n    },\n    trash(options) {\n      currentMode.trash(options);\n    },\n    combineFeatures() {\n      currentMode.combineFeatures();\n    },\n    uncombineFeatures() {\n      currentMode.uncombineFeatures();\n    },\n    getMode() {\n      return currentModeName;\n    }\n  };\n\n  return api;\n}\n"]},"metadata":{},"sourceType":"module"}